*--------------------------------------------------------------------------------------------------------------------------------------------------------
* (ES) AUTOGENERADO - ¡¡ATENCIÓN!! - ¡¡NO PENSADO PARA EJECUTAR!! USAR SOLAMENTE PARA INTEGRAR CAMBIOS Y ALMACENAR CON HERRAMIENTAS SCM!!
* (EN) AUTOGENERATED - ATTENTION!! - NOT INTENDED FOR EXECUTION!! USE ONLY FOR MERGING CHANGES AND STORING WITH SCM TOOLS!!
*--------------------------------------------------------------------------------------------------------------------------------------------------------
*< FOXBIN2PRG: Version="1.19" SourceFile="vouchers.scx" /> (Solo para binarios VFP 9 / Only for VFP 9 binaries)
*
*
DEFINE CLASS dataenvironment AS dataenvironment 
 	*< CLASSDATA: Baseclass="dataenvironment" Timestamp="" Scale="" Uniqueid="" ClassIcon="2" />

	*-- OBJECTDATA items order determines ZOrder / El orden de los items OBJECTDATA determina el ZOrder 
	*< OBJECTDATA: ObjPath="Cursor6" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cursor7" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cursor8" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cursor9" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Relation2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cursor10" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cursor11" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cursor1" UniqueID="" Timestamp="" />

	AutoOpenTables = .F.
	DataSource = .NULL.
	Height = 472
	Left = 19
	Name = "Dataenvironment"
	Top = 35
	Width = 571

	ADD OBJECT 'Cursor1' AS cursor WITH ;
		Alias = "histpost", ;
		CursorSource = ..\data\histpost.dbf, ;
		Height = 90, ;
		Left = 386, ;
		Name = "Cursor1", ;
		Top = 5, ;
		Width = 90
		*< END OBJECT: BaseClass="cursor" />

	ADD OBJECT 'Cursor10' AS cursor WITH ;
		Alias = "lists", ;
		CursorSource = ..\data\lists.dbf, ;
		Height = 90, ;
		Left = 253, ;
		Name = "Cursor10", ;
		Top = 122, ;
		Width = 110
		*< END OBJECT: BaseClass="cursor" />

	ADD OBJECT 'Cursor11' AS cursor WITH ;
		Alias = "reservat", ;
		CursorSource = ..\data\reservat.dbf, ;
		Height = 90, ;
		Left = 253, ;
		Name = "Cursor11", ;
		Top = 2, ;
		Width = 110
		*< END OBJECT: BaseClass="cursor" />

	ADD OBJECT 'Cursor6' AS cursor WITH ;
		Alias = "voucher", ;
		CursorSource = ..\data\voucher.dbf, ;
		Height = 90, ;
		Left = 1, ;
		Name = "Cursor6", ;
		Top = 2, ;
		Width = 90
		*< END OBJECT: BaseClass="cursor" />

	ADD OBJECT 'Cursor7' AS cursor WITH ;
		Alias = "address", ;
		CursorSource = ..\data\address.dbf, ;
		Height = 90, ;
		Left = 135, ;
		Name = "Cursor7", ;
		Order = "tag1", ;
		Top = 3, ;
		Width = 110
		*< END OBJECT: BaseClass="cursor" />

	ADD OBJECT 'Cursor8' AS cursor WITH ;
		Alias = "article", ;
		CursorSource = ..\data\article.dbf, ;
		Height = 90, ;
		Left = 135, ;
		Name = "Cursor8", ;
		Top = 122, ;
		Width = 110
		*< END OBJECT: BaseClass="cursor" />

	ADD OBJECT 'Cursor9' AS cursor WITH ;
		Alias = "post", ;
		CursorSource = ..\data\post.dbf, ;
		Height = 90, ;
		Left = 1, ;
		Name = "Cursor9", ;
		Top = 123, ;
		Width = 110
		*< END OBJECT: BaseClass="cursor" />

	ADD OBJECT 'Relation2' AS relation WITH ;
		ChildAlias = "article", ;
		ChildOrder = "tag1", ;
		Name = "Relation2", ;
		ParentAlias = "post", ;
		RelationalExpr = "ps_artinum"
		*< END OBJECT: BaseClass="relation" />

ENDDEFINE

DEFINE CLASS frsvouchers AS formset 
 	*< CLASSDATA: Baseclass="formset" Timestamp="" Scale="" Uniqueid="" />

	*-- OBJECTDATA items order determines ZOrder / El orden de los items OBJECTDATA determina el ZOrder 
	*< OBJECTDATA: ObjPath="frmVoucherBrw" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmVoucherBrw.grdVoucherBrw" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmVoucherBrw.cmdGetFocus" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.lblCreateDate" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.lblVoucherNumber" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.lblMinUnusedAmount" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.lblOriginalAmount" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.lblDescription" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.lblName" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.dtxtCreateDate" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.txtVoucherNumber" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.txtMinUnusedAmount" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.txtOriginalAmount" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.txtDescription" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.txtName" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.cmdOK" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.cmdCancel" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.chkExact" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.dtxtExpDate" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.lblExpDate" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmSearch.chkUnPrinted" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmEdit" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmEdit.lblDescription" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmEdit.txtDescription" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmEdit.cmdOK" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmEdit.cmdCancel" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmEdit.edtAddress" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmEdit.cmdAddress" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmEdit.edtNote" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="frmEdit.lblNote" UniqueID="" Timestamp="" />

	*<DefinedPropArrayMethod>
		*m: m_address
		*m: m_edit
		*m: m_findvoucher		&& Finds voucher with given vo_number.
		*m: m_requeryvoucher
		*m: m_search
		*m: notpaid
		*m: onbill
		*m: onclose
		*m: ondelete
		*m: onedit
		*m: onextvouchers
		*m: onnew
		*m: onprint
		*m: onsearch
		*m: setaddress
		*p: lextvoucheractive
	*</DefinedPropArrayMethod>

	AutoRelease = .T.
	DataSession = 2
	lextvoucheractive = .F.
	Name = "frsVouchers"

	ADD OBJECT 'frmEdit' AS tform WITH ;
		AlwaysOnTop = .F., ;
		Caption = "frmEdit", ;
		ControlBox = .T., ;
		DoCreate = .T., ;
		Height = 266, ;
		MaxButton = .F., ;
		MinButton = .F., ;
		Name = "frmEdit", ;
		Visible = .F., ;
		Width = 395
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="form" />

	ADD OBJECT 'frmEdit.cmdAddress' AS tcommandbutton WITH ;
		Caption = "cmdAddress", ;
		Height = 24, ;
		Left = 295, ;
		Name = "cmdAddress", ;
		TabIndex = 5, ;
		Top = 42, ;
		Width = 90
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'frmEdit.cmdCancel' AS tcommandbutton WITH ;
		Cancel = .T., ;
		Caption = "cmdCancel", ;
		Height = 24, ;
		Left = 295, ;
		Name = "cmdCancel", ;
		TabIndex = 6, ;
		Top = 74, ;
		Width = 90
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'frmEdit.cmdOK' AS tcommandbutton WITH ;
		Caption = "cmdOK", ;
		Height = 24, ;
		Left = 295, ;
		Name = "cmdOK", ;
		TabIndex = 4, ;
		Top = 10, ;
		Width = 90
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'frmEdit.edtAddress' AS teditbox WITH ;
		ForeColor = 0,0,255, ;
		Height = 90, ;
		Left = 10, ;
		Name = "edtAddress", ;
		ReadOnly = .T., ;
		resizefontsize = .F., ;
		TabIndex = 2, ;
		Top = 38, ;
		Width = 270
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="editbox" />

	ADD OBJECT 'frmEdit.edtNote' AS teditbox WITH ;
		Height = 108, ;
		Left = 10, ;
		Name = "edtNote", ;
		TabIndex = 3, ;
		Top = 153, ;
		Width = 270
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="editbox" />

	ADD OBJECT 'frmEdit.lblDescription' AS tlabel WITH ;
		Caption = "lblDescription", ;
		Height = 17, ;
		Left = 10, ;
		Name = "lblDescription", ;
		TabIndex = 7, ;
		Top = 13, ;
		Width = 110
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="label" />

	ADD OBJECT 'frmEdit.lblNote' AS tlabel WITH ;
		Caption = "lblDescription", ;
		Height = 17, ;
		Left = 10, ;
		Name = "lblNote", ;
		TabIndex = 7, ;
		Top = 132, ;
		Width = 110
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="label" />

	ADD OBJECT 'frmEdit.txtDescription' AS ttext WITH ;
		Height = 23, ;
		Left = 125, ;
		Name = "txtDescription", ;
		TabIndex = 1, ;
		Top = 10, ;
		Width = 155
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="textbox" />

	ADD OBJECT 'frmSearch' AS tform WITH ;
		AlwaysOnTop = .F., ;
		Caption = "frmSearch", ;
		ControlBox = .T., ;
		DoCreate = .T., ;
		Height = 211, ;
		MaxButton = .F., ;
		MinButton = .F., ;
		Name = "frmSearch", ;
		Visible = .F., ;
		Width = 390
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="form" />

	ADD OBJECT 'frmSearch.chkExact' AS tcheckbox WITH ;
		Alignment = 0, ;
		Caption = "Exakte Suche", ;
		Height = 17, ;
		Left = 260, ;
		Name = "chkExact", ;
		TabIndex = 9, ;
		Top = 181, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="checkbox" />

	ADD OBJECT 'frmSearch.chkUnPrinted' AS tcheckbox WITH ;
		Alignment = 0, ;
		Caption = "Nur ungedruckte", ;
		Height = 17, ;
		Left = 260, ;
		Name = "chkUnPrinted", ;
		TabIndex = 5, ;
		Top = 97, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="checkbox" />

	ADD OBJECT 'frmSearch.cmdCancel' AS tcommandbutton WITH ;
		Cancel = .T., ;
		Caption = "cmdCancel", ;
		Height = 24, ;
		Left = 290, ;
		Name = "cmdCancel", ;
		TabIndex = 11, ;
		Top = 48, ;
		Width = 90
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'frmSearch.cmdOK' AS tcommandbutton WITH ;
		Caption = "cmdOK", ;
		Default = .T., ;
		Height = 24, ;
		Left = 290, ;
		Name = "cmdOK", ;
		TabIndex = 10, ;
		Top = 12, ;
		Width = 90
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'frmSearch.dtxtCreateDate' AS tdatectrl WITH ;
		Height = 23, ;
		Left = 130, ;
		Name = "dtxtCreateDate", ;
		TabIndex = 1, ;
		Top = 10, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="textbox" />

	ADD OBJECT 'frmSearch.dtxtExpDate' AS tdatectrl WITH ;
		Left = 130, ;
		Name = "dtxtExpDate", ;
		TabIndex = 2, ;
		Top = 38, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="textbox" />

	ADD OBJECT 'frmSearch.lblCreateDate' AS tlabel WITH ;
		Caption = "Verkaufsdatum", ;
		Height = 17, ;
		Left = 5, ;
		Name = "lblCreateDate", ;
		TabIndex = 12, ;
		Top = 13, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="label" />

	ADD OBJECT 'frmSearch.lblDescription' AS tlabel WITH ;
		Caption = "Beschreibung:", ;
		Height = 17, ;
		Left = 5, ;
		Name = "lblDescription", ;
		TabIndex = 14, ;
		Top = 69, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="label" />

	ADD OBJECT 'frmSearch.lblExpDate' AS tlabel WITH ;
		Caption = "Ablaufsdatum", ;
		Left = 5, ;
		Name = "lblExpDate", ;
		TabIndex = 13, ;
		Top = 41, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="label" />

	ADD OBJECT 'frmSearch.lblMinUnusedAmount' AS tlabel WITH ;
		Caption = "Betrag Offen ab:", ;
		Height = 17, ;
		Left = 5, ;
		Name = "lblMinUnusedAmount", ;
		TabIndex = 16, ;
		Top = 125, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="label" />

	ADD OBJECT 'frmSearch.lblName' AS tlabel WITH ;
		Caption = "Name", ;
		Height = 17, ;
		Left = 5, ;
		Name = "lblName", ;
		TabIndex = 18, ;
		Top = 181, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="label" />

	ADD OBJECT 'frmSearch.lblOriginalAmount' AS tlabel WITH ;
		Caption = "Originalbetrag:", ;
		Height = 17, ;
		Left = 5, ;
		Name = "lblOriginalAmount", ;
		TabIndex = 17, ;
		Top = 153, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="label" />

	ADD OBJECT 'frmSearch.lblVoucherNumber' AS tlabel WITH ;
		Caption = "Gutscheinnummer", ;
		Height = 17, ;
		Left = 5, ;
		Name = "lblVoucherNumber", ;
		TabIndex = 15, ;
		Top = 97, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="label" />

	ADD OBJECT 'frmSearch.txtDescription' AS ttext WITH ;
		Height = 23, ;
		Left = 130, ;
		Name = "txtDescription", ;
		TabIndex = 3, ;
		Top = 66, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="textbox" />

	ADD OBJECT 'frmSearch.txtMinUnusedAmount' AS ttext WITH ;
		Height = 23, ;
		Left = 130, ;
		Name = "txtMinUnusedAmount", ;
		TabIndex = 6, ;
		Top = 122, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="textbox" />

	ADD OBJECT 'frmSearch.txtName' AS ttext WITH ;
		Height = 23, ;
		Left = 130, ;
		Name = "txtName", ;
		TabIndex = 8, ;
		Top = 178, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="textbox" />

	ADD OBJECT 'frmSearch.txtOriginalAmount' AS ttext WITH ;
		Height = 23, ;
		Left = 130, ;
		Name = "txtOriginalAmount", ;
		TabIndex = 7, ;
		Top = 150, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="textbox" />

	ADD OBJECT 'frmSearch.txtVoucherNumber' AS ttext WITH ;
		Height = 23, ;
		Left = 130, ;
		Name = "txtVoucherNumber", ;
		TabIndex = 4, ;
		Top = 94, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="textbox" />

	ADD OBJECT 'frmVoucherBrw' AS tform WITH ;
		AlwaysOnTop = .F., ;
		AutoCenter = .F., ;
		Caption = "frmVoucherBrw", ;
		ControlBox = .T., ;
		ctbrclass = ctbrvouchers, ;
		DoCreate = .T., ;
		Height = 400, ;
		Icon = ..\bitmap\icons\gift.ico, ;
		KeyPreview = .T., ;
		Name = "frmVoucherBrw", ;
		resizeheaderfont = .F., ;
		saveformsize = .T., ;
		savegridwidths = .T., ;
		Visible = .F., ;
		Width = 617
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="form" />

	ADD OBJECT 'frmVoucherBrw.cmdGetFocus' AS tcommandbutton WITH ;
		Left = 0, ;
		Name = "cmdGetFocus", ;
		Top = 408
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'frmVoucherBrw.grdVoucherBrw' AS grdbase WITH ;
		AllowHeaderSizing = .F., ;
		AllowRowSizing = .F., ;
		ColumnCount = 0, ;
		DeleteMark = .F., ;
		GridLineColor = 192,192,192, ;
		GridLines = 2, ;
		Height = 398, ;
		Left = 1, ;
		lresizecolumns = .F., ;
		Name = "grdVoucherBrw", ;
		p_basecolumncontrol = tbgrid, ;
		p_showselectedrowinblue = .T., ;
		RecordMark = .F., ;
		resizefontsize = .F., ;
		ScrollBars = 2, ;
		setcolumns = .T., ;
		Top = 1, ;
		Width = 615
		*< END OBJECT: ClassLib="..\libs\main.vcx" BaseClass="grid" />
	
	PROCEDURE Init
		this.frmVoucherBrw.Show()
	ENDPROC

	PROCEDURE Load
		ini(.T.,.T.,this.DataEnvironment)
	ENDPROC

	PROCEDURE m_address
		LOCAL l_cAddText, l_nAddRn
		LOCAL ARRAY LArray(12)
		
		IF NOT EMPTY(this.frmEdit.nAddrId)
			l_cAddText = ""
			LOCAL l_nRecNo
			l_nRecNo = RECNO("address")
			= SEEK(this.frmEdit.nAddrId, "address", "tag1")
			l_nAddRn = RECNO("address")
			GO l_nRecNo IN address
		ELSE
			l_cAddText = "A"
			l_nAddRn = 0
		ENDIF
		
		LArray(1) = "BRWL"
		LArray(2) = l_cAddText
		LArray(3) = 2
		LArray(4) = "VOUCH"
		LArray(5) = l_nAddRn
		LArray(6) = 0
		LArray(7) = 17
		LArray(8) = 0
		LArray(9) = thisformset.frmEdit
		LArray(12) = .T.
		doform('addressmask','forms\addressmask','',.F.,@LArray)
		
		RETURN .T.
	ENDPROC

	PROCEDURE m_edit
		* Change Desc and Addr in Voucher table and in tblVoucher cursor.
		LOCAL l_nTblAddrId
		l_nTblAddrId = IIF(ISNULL(tblVoucher.ad_addrid),0,tblVoucher.ad_addrid)
		IF tblVoucher.vo_descrip <> this.frmEdit.txtDescription.Value OR ;
				l_nTblAddrId <> this.frmEdit.nAddrId OR NOT (tblVoucher.vo_note == this.frmEdit.edtNote.Value)
			IF this.m_findvoucher()
				REPLACE vo_descrip WITH this.frmEdit.txtDescription.Value, ;
						vo_addrid WITH this.frmEdit.nAddrId, ;
						vo_note WITH this.frmEdit.edtNote.Value ;
						IN voucher
				REPLACE vo_descrip WITH this.frmEdit.txtDescription.Value, ;
						vo_addrid WITH this.frmEdit.nAddrId, ;
						vo_note WITH this.frmEdit.edtNote.Value ;
						IN tblVoucher
				IF l_nTblAddrId <> this.frmEdit.nAddrId AND ;
						SEEK(this.frmEdit.nAddrId,"address","tag1")
					LOCAL l_oAddress
					SELECT address
					SCATTER MEMO NAME l_oAddress
					SELECT tblVoucher
					GATHER MEMO NAME l_oAddress
				ENDIF
			ELSE
				= alert(GetLangText("VOUCHER","TXT_CHANGE_FAIL"))
			ENDIF
		ENDIF
	ENDPROC

	PROCEDURE m_findvoucher		&& Finds voucher with given vo_number.
		LOCAL l_lFound
		l_lFound = .T.
		IF tblVoucher.vo_number <> voucher.vo_number
			IF NOT SEEK(STR(tblVoucher.vo_number,10)+STR(tblVoucher.vo_copy,2), ;
					"voucher","tag3")
				LOCAL l_nArea
				l_nArea = SELECT()
				SELECT voucher
				LOCATE FOR voucher.vo_number = tblVoucher.vo_number
				l_lFound = FOUND("voucher")
				SELECT(l_nArea)
			ENDIF
		ENDIF
		RETURN l_lFound
	ENDPROC

	PROCEDURE m_requeryvoucher
		LPARAMETERS lp_cVouchNumber, lp_dPurchDate, lp_dExpDate, lp_cDescript, ;
				lp_nMinUnused, lp_nAmount, lp_lUnPrinted, lp_cLName, lp_lExact
		
		DO VaucherFilter IN ProcVoucher WITH ;
				lp_cVouchNumber, lp_dPurchDate, lp_dExpDate, lp_cDescript, ;
				lp_nMinUnused, lp_nAmount, lp_lUnPrinted, lp_cLName, lp_lExact, ;
				"tblFilterVoucher"
		
		this.frmVoucherBrw.cmdGetFocus.SetFocus()
		
		SELECT tblVoucher
		ZAP
		APPEND FROM DBF("tblFilterVoucher")
		
		this.frmVoucherBrw.Activate()
		this.frmVoucherBrw.grdVoucherBrw.SetFocus()
		
	ENDPROC

	PROCEDURE m_search
		this.m_requeryvoucher( ;
				"", ;
				{}, ;
				{}, ;
				"", ;
				this.frmSearch.txtMinUnusedAmount.Value, ;
				this.frmSearch.txtOriginalAmount.Value, ;
				this.frmSearch.chkUnPrinted.Value, ;
				this.frmSearch.txtName.Value, ;
				this.frmSearch.chkExact.Value)
		
		DO VaucherSearch IN ProcVoucher WITH "tblVoucher", ;
				this.frmSearch.txtVoucherNumber.Value, ;
				this.frmSearch.dtxtCreateDate.Value, ;
				this.frmSearch.dtxtExpDate.Value, ;
				this.frmSearch.txtDescription.Value
		
	ENDPROC

	PROCEDURE notpaid
		LOCAL l_nNotPaid, l_lVoucherDebitorPaied
		l_nNotPaid = 0
		
		IF _screen.oglobal.oparam2.pa_vodebch
		     IF tblVoucher.c_npcalc
		          l_nNotPaid = tblVoucher.c_notpaid
		     ELSE
		          IF tblVoucher.vo_amount = tblVoucher.vo_unused
		               l_lVoucherDebitorPaied = ProcVoucher("VaucherCheckDebitForOne", tblVoucher.vo_number)
		          ELSE
		               l_lVoucherDebitorPaied = .T.
		          ENDIF
		          l_nNotPaid = IIF(l_lVoucherDebitorPaied,0,1)
		          REPLACE c_npcalc WITH .T., ;
		               c_notpaid WITH l_nNotPaid ;
		               IN tblVoucher
		          
		     ENDIF
		ENDIF
		
		RETURN l_nNotPaid
	ENDPROC

	PROCEDURE onbill
		IF NOT RECCOUNT("tblVoucher")=0 AND NOT EMPTY(tblVoucher.vo_number)
			LOCAL ARRAY l_aParams(1)
			l_aParams(1) = tblVoucher.vo_number
			doform('billhist', 'forms\billhistory','',.F.,@l_aParams)
		ENDIF
	ENDPROC

	PROCEDURE onclose
		LOCAL l_oForm
		
		IF this.lextvoucheractive
			* Close ext vouchers form
			FOR EACH l_oForm IN _screen.Forms
				IF UPPER(l_oForm.BaseClass) = "FORM" AND l_oForm.Visible AND l_oForm.Enabled AND ;
						TYPE("l_oForm.FormName") = "C" AND LOWER(ALLTRIM(l_oForm.FormName)) == "frmvoucherextbrw"
					l_oForm.OnClose()
					EXIT
				ENDIF
			ENDFOR
		ENDIF
		
		this.frmVoucherBrw.HideToolbar()
		this.Release()
	ENDPROC

	PROCEDURE ondelete
		IF this.m_findvoucher()
			LOCAL l_lReturn
			DO VauchersDelete IN ProcVoucher WITH l_lReturn
			IF l_lReturn
				REPLACE vo_amount WITH tblVoucher.vo_amount-tblVoucher.vo_unused IN tblVoucher
				REPLACE vo_unused WITH 0 IN tblVoucher
			ENDIF
		ENDIF
	ENDPROC

	PROCEDURE onedit
		IF tblVoucher.vo_unused > 0
			* Initialization of frmEdit
			this.frmEdit.txtDescription.Value = tblVoucher.vo_descrip
			this.frmEdit.edtNote.Value = tblVoucher.vo_note
			this.frmEdit.nAddrId = tblVoucher.vo_addrid
			this.SetAddress()
			* Show frmEdit
			this.frmVoucherBrw.Enabled = .F.
			this.frmEdit.Show()
		ELSE
			= alert(GetLangText("VOUCHER","TXT_CHANGE_DISABLED"))
		ENDIF
	ENDPROC

	PROCEDURE onextvouchers
		LOCAL ARRAY LArray(1)
		this.lextvoucheractive = .T.
		LArray(1) = this
		doform('frmvoucherextbrw', 'forms\vouchersext','',.F.,@LArray)
	ENDPROC

	PROCEDURE onnew
		LPARAMETERS lp_nVeId, lp_nAddrID, lp_nAmount1, lp_nAmount2, lp_nArtiNum1, lp_nArtiNum2, lp_nPayTyp
		LOCAL l_lSuccess
		l_lSuccess = .F.
		
		IF VARTYPE(_screen.oglobal.oExtVouchersData)<>"O"
			_screen.oglobal.oExtVouchersData = CREATEOBJECT("Empty")
			ADDPROPERTY(_screen.oglobal.oExtVouchersData, "nveid", 0)
			ADDPROPERTY(_screen.oglobal.oExtVouchersData, "naddrid", 0)
			ADDPROPERTY(_screen.oglobal.oExtVouchersData, "nAmount1", 0.00)
			ADDPROPERTY(_screen.oglobal.oExtVouchersData, "nAmount2", 0.00)
			ADDPROPERTY(_screen.oglobal.oExtVouchersData, "nArtiNum1", 0)
			ADDPROPERTY(_screen.oglobal.oExtVouchersData, "nArtiNum2", 0)
			ADDPROPERTY(_screen.oglobal.oExtVouchersData, "nPayTyp", 0)
			ADDPROPERTY(_screen.oglobal.oExtVouchersData, "lSuccess", 0)
		ENDIF
		
		_screen.oglobal.oExtVouchersData.nveid = lp_nVeId
		_screen.oglobal.oExtVouchersData.naddrid = lp_nAddrID
		_screen.oglobal.oExtVouchersData.nAmount1 = lp_nAmount1
		_screen.oglobal.oExtVouchersData.nAmount2 = lp_nAmount2
		_screen.oglobal.oExtVouchersData.nArtiNum1 = lp_nArtiNum1
		_screen.oglobal.oExtVouchersData.nArtiNum2 = lp_nArtiNum2
		_screen.oglobal.oExtVouchersData.nPayTyp = lp_nPayTyp
		_screen.oglobal.oExtVouchersData.lSuccess = .F.
		
		* Make new voucher.
		DO VouchersNew IN ProcVoucher
		
		l_lSuccess = _screen.oglobal.oExtVouchersData.lSuccess
		
		_screen.oglobal.oExtVouchersData = .NULL.
		
		* Requery grid.
		this.m_requeryvoucher("",{},{},"",0,0,.F.,"",.F.)
		
		RETURN l_lSuccess
	ENDPROC

	PROCEDURE onprint
		LOCAL l_lPrint
		l_lPrint = .T.
		IF tblVoucher.vo_copy > 0 AND tblVoucher.vo_unused > 0
			l_lPrint = yesno(GetLangText("VOUCHER","TXT_PRINT_EXCLAMATION") + ;
					";" + GetLangText("VOUCHER","TXT_PRINT_QUESTION"))
		ENDIF
		IF tblVoucher.vo_unused > 0 AND l_lPrint AND this.m_findvoucher()
			IF voucher.vo_copy > 0
				REPLACE vo_copy WITH voucher.vo_copy-1 IN voucher
			ENDIF
			DO VoucherPrint IN ProcVoucher WITH "", .F.
			REPLACE vo_copy WITH voucher.vo_copy+1 IN voucher
			REPLACE vo_copy WITH voucher.vo_copy IN tblVoucher
		ENDIF
	ENDPROC

	PROCEDURE onsearch
		this.frmSearch.dtxtCreateDate.Value = {}
		this.frmSearch.txtDescription.Value = ""
		this.frmSearch.txtVoucherNumber.Value = ""
		this.frmSearch.txtMinUnusedAmount.Value = 0
		this.frmSearch.txtOriginalAmount.Value = 0
		this.frmSearch.txtName.Value = ""
		this.frmSearch.chkExact.Value = .F.
		this.frmSearch.chkUnPrinted.Value = .F.
		
		this.frmVoucherBrw.Enabled = .F.
		this.frmSearch.Show()
	ENDPROC

	PROCEDURE setaddress
		LPARAMETERS lp_nAddrid
		IF PCOUNT() > 0
			this.frmEdit.nAddrId = lp_nAddrid
		ENDIF
		
		IF NOT EMPTY(this.frmEdit.nAddrId) AND ;
				SEEK(this.frmEdit.nAddrId,"address","tag1")
			this.frmEdit.AddObject("oCheckRes","checkreservat")
			this.frmEdit.edtAddress.Value = ;
					this.frmEdit.oCheckRes.rs_bill_fulladdress(this.frmEdit.nAddrId)
			this.frmEdit.RemoveObject("oCheckRes")
		ELSE
			this.frmEdit.edtAddress.Value = ""
		ENDIF
	ENDPROC

	PROCEDURE frmEdit.Activate
		this.cmdOK.Default = .T.
		DODEFAULT()
	ENDPROC

	PROCEDURE frmEdit.cmdAddress.Click
		thisformset.m_address()
	ENDPROC

	PROCEDURE frmEdit.cmdCancel.Click
		thisform.QueryUnload()
	ENDPROC

	PROCEDURE frmEdit.cmdOK.Click
		thisformset.m_edit()
		thisform.QueryUnload()
	ENDPROC

	PROCEDURE frmEdit.Init
		DODEFAULT()
		
		this.AddProperty("nAddrId",0)
		
		this.Caption = GetLangText("VOUCHER","TXT_EDIT_VOUCHER")
		this.lblDescription.Caption = GetLangText("VOUCHER","TXT_DESCRIPTION")
		this.edtAddress.ToolTipText = GetLangText("VOUCHER","TT_CHANGE_ADDRESS")
		this.cmdAddress.Caption = GetLangText("COMMON","TXT_ADDRESSES")
		this.lblNote.Caption = GetLangText("ACT","T_NOTE")
		this.cmdCancel.Caption = GetLangText("COMMON","TXT_CANCEL")
		this.cmdOK.Caption = GetLangText("COMMON","TXT_OK")
		this.ShowTips = .T.
	ENDPROC

	PROCEDURE frmEdit.KeyPress
		LPARAMETERS nKeyCode, nShiftAltCtrl
		* Overlap parent.
	ENDPROC

	PROCEDURE frmEdit.QueryUnload
		this.Hide()
		thisformset.frmVoucherBrw.Enabled = .T.
		NODEFAULT
	ENDPROC

	PROCEDURE frmSearch.Activate
		this.cmdOK.Default = .T.
		DODEFAULT()
	ENDPROC

	PROCEDURE frmSearch.cmdCancel.Click
		thisform.QueryUnload()
	ENDPROC

	PROCEDURE frmSearch.cmdOK.Click
		thisformset.m_search()
		thisform.QueryUnload()
	ENDPROC

	PROCEDURE frmSearch.Init
		DODEFAULT()
		
		this.Caption = GetLangText("VOUCHER","TXT_VOSEARCH")
		this.lblCreateDate.Caption = GetLangText("VOUCHER","TXT_PURCHDATE")
		this.lblExpDate.Caption = GetLangText("VOUCHER","TXT_EXPDATE")
		this.lblDescription.Caption = GetLangText("VOUCHER","TXT_DESCRIPTION")
		this.lblMinUnusedAmount.Caption = GetLangText("VOUCHER","TXT_MINUNUSED")
		this.lblName.Caption = GetLangText("VOUCHER","TXT_LNAME")
		this.chkExact.Caption = GetLangText("VOUCHER","TXT_EXACT")
		this.lblOriginalAmount.Caption = GetLangText("VOUCHER","TXT_ORIG_AMOUNT")
		this.lblVoucherNumber.Caption = GetLangText("VOUCHER","TXT_VONUMBER")
		this.chkUnPrinted.Caption = GetLangText("VOUCHER","TXT_ONLY_UNPRINTED")
		this.cmdCancel.Caption = GetLangText("COMMON","TXT_CANCEL")
		this.cmdOK.Caption = GetLangText("COMMON","TXT_OK")
		
		IF param.pa_vounoex
			this.dtxtExpDate.Enabled = .F.
		ENDIF
		
		this.txtDescription.InputMask = REPLICATE("!", 25)
		this.txtVoucherNumber.InputMask = REPLICATE("9", 12)
		this.txtMinUnusedAmount.InputMask = gcCurrcy
		this.txtOriginalAmount.InputMask = gcCurrcy
	ENDPROC

	PROCEDURE frmSearch.KeyPress
		LPARAMETERS nKeyCode, nShiftAltCtrl
		* Overlap parent.
	ENDPROC

	PROCEDURE frmSearch.QueryUnload
		this.Hide()
		thisformset.frmVoucherBrw.Enabled = .T.
		NODEFAULT
	ENDPROC

	PROCEDURE frmVoucherBrw.grdVoucherBrw.Init
		IF this.ColumnCount > 0
			DODEFAULT()
		ENDIF
	ENDPROC

	PROCEDURE frmVoucherBrw.Init
		ProcVoucher("VaucherTblCreate", "tblVoucher", ".T.", "", .T.,.T.)
		
		this.Caption = GetLangText("VOUCHER","TXT_BRW_VOUCHER")
		
		WITH this.grdVoucherBrw
			IF _screen.oglobal.oparam2.pa_vodebch
				* Remove blue backcolor for selected line, so user can see when some voucher is red.
				.HighlightStyle = 0
				.HighlightRowLineWidth = 3
			ENDIF
			.ColumnCount = 12
			*.Column1.Width = 70
			*.Column2.Width = 70
			*.Column3.Width = 120
			*.Column4.Width = 60
			*.Column5.Width = 60
			.Column6.Width = 200
			*.Column7.Width = 120
			.Column1.Header1.Caption = GetLangText("VOUCHER","TXT_EXPDATE")
			.Column2.Header1.Caption = GetLangText("VOUCHER","TXT_PURCHDATE")
			.Column3.Header1.Caption = GetLangText("VOUCHER","TXT_DESCRIPTION")
			.Column4.Header1.Caption = GetLangText("VOUCHER","TXT_AMNT")
			.Column5.Header1.Caption = GetLangText("VOUCHER","TXT_UNUSED")
			.Column6.Header1.Caption = GetLangText("VOUCHER","TXT_VONUMBER")
			.Column7.Header1.Caption = GetLangText("VOUCHER","TXT_NAME")
			.Column8.Header1.Caption = GetLangText("ACT","T_NOTE")
			.Column9.Header1.Caption = GetLangText("CHKOUT2","T_SUPPLEM")
			.Column10.Header1.Caption = GetLangText("MGRPLIST","TXT_VGNUM")
			.Column11.Header1.Caption = GetLangText("MGRPLIST","TXT_VGLANG")
			.Column12.Header1.Caption = GetLangText("MGRPLIST","TXT_VGPERC")
			.RecordSource = "tblVoucher"
			.Column1.ControlSource = "tblVoucher.vo_expdate"
			.Column2.ControlSource = "tblVoucher.vo_created"
			.Column3.ControlSource = "tblVoucher.vo_descrip"
			.Column4.ControlSource = "tblVoucher.vo_amount"
			.Column5.ControlSource = "tblVoucher.vo_unused"
			.Column6.ControlSource = "STR(tblVoucher.vo_number,10)+strzero(tblVoucher.vo_copy,2)"+IIF(_screen.oGlobal.lexternalvouchers,"+IIF(EMPTY(tblVoucher.vo_veid),'',' (Ext-'+ALLTRIM(tblVoucher.ve_vouchno)+')')","")
			.Column7.ControlSource = "IIF(ISNULL(tblVoucher.ad_lname),'',tblVoucher.ad_lname)"
			.Column8.ControlSource = "IIF(NOT EMPTY(tblVoucher.vo_note),[" + GetLangText("AR","T_YES") + "],[" + GetLangText("AR","T_NO") + "])"
			.Column9.ControlSource = "ICASE(NOT EMPTY(tblVoucher.ps_supplem),tblVoucher.ps_supplem,NOT EMPTY(tblVoucher.hp_supplem),tblVoucher.hp_supplem,'')"
			.Column10.ControlSource = "IIF(EMPTY(tblVoucher.vo_vat),'',TRANSFORM(tblVoucher.vo_vat))"
			.Column11.ControlSource = "tblVoucher.vo_vatdesc"
			.Column12.ControlSource = "IIF(EMPTY(tblVoucher.vo_vatval),'',TRANSFORM(tblVoucher.vo_vatval,'99.99%'))"
			IF param.pa_vounoex
				.RemoveObject("Column1")
			ENDIF
			.Init()
			.SetAll("DynamicForeColor", "IIF(thisformset.NotPaid()=0,RGB(0,0,0),RGB(255,0,0))", "Column")
		ENDWITH
		
		DODEFAULT()
	ENDPROC

	PROCEDURE frmVoucherBrw.Load
		DODEFAULT()
		
		IF _screen.oGlobal.lexternalvouchers
			openfile(.F.,"extvouch")
		ENDIF
		
		RETURN .T.
	ENDPROC

	PROCEDURE frmVoucherBrw.onclose
		thisformset.OnClose()
	ENDPROC

	PROCEDURE frmVoucherBrw.onrefresh
		LPARAMETERS toControl
		LOCAL l_nRecNo
		l_nRecNo = RECNO(this.grdVoucherBrw.RecordSource)
		thisformset.m_requeryvoucher("",{},{},"",0,0,.F.,"",.F.)
		GO l_nRecNo IN (this.grdVoucherBrw.RecordSource)
		RETURN .T.
	ENDPROC

	PROCEDURE frmVoucherBrw.QueryUnload
		thisform.OnClose()
		NODEFAULT
	ENDPROC

ENDDEFINE
