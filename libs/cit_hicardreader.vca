*--------------------------------------------------------------------------------------------------------------------------------------------------------
* (ES) AUTOGENERADO - ¡¡ATENCIÓN!! - ¡¡NO PENSADO PARA EJECUTAR!! USAR SOLAMENTE PARA INTEGRAR CAMBIOS Y ALMACENAR CON HERRAMIENTAS SCM!!
* (EN) AUTOGENERATED - ATTENTION!! - NOT INTENDED FOR EXECUTION!! USE ONLY FOR MERGING CHANGES AND STORING WITH SCM TOOLS!!
*--------------------------------------------------------------------------------------------------------------------------------------------------------
*< FOXBIN2PRG: Version="1.19" SourceFile="cit_hicardreader.vcx" /> (Solo para binarios VFP 9 / Only for VFP 9 binaries)
*
*
DEFINE CLASS crhealthcard AS tform OF "..\common\libs\_lvisual.vcx" 
 	*< CLASSDATA: Baseclass="form" Timestamp="" Scale="Pixels" Uniqueid="" />

	*-- OBJECTDATA items order determines ZOrder / El orden de los items OBJECTDATA determina el ZOrder 
	*< OBJECTDATA: ObjPath="oHealthCard" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="lblAddr" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="edtAddr1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="lblIns" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="edtIns1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="edtSum1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Shape1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Shape2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Shape3" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="edtAddr2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="edtIns2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="edtSum2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="cmdUpdate" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="cmdOpenInAddress" UniqueID="" Timestamp="" />

	*<DefinedPropArrayMethod>
		*m: displaycontent
		*m: loaddataenv
		*m: moveform
		*m: oncardpresent
		*m: oncardremove
		*m: onopeninaddressbook
		*m: onupdate
		*m: oparent_assign
		*m: setdebugdata
		*p: lportopened
		*p: naddrid
		*p: nresercnt
		*p: oparent
	*</DefinedPropArrayMethod>

	AutoCenter = .F.
	BorderStyle = 2
	Caption = "Card Reader"
	DataSession = 2
	DoCreate = .T.
	Height = 444
	naddrid = 0
	Name = "crhealthcard"
	nresercnt = 0
	oparent = .NULL.
	TitleBar = 0
	Visible = .F.
	Width = 264

	ADD OBJECT 'cmdOpenInAddress' AS commandbutton WITH ;
		Caption = "Open in address book", ;
		Height = 27, ;
		Left = 108, ;
		Name = "cmdOpenInAddress", ;
		Top = 408, ;
		Width = 144, ;
		ZOrderSet = 13
		*< END OBJECT: BaseClass="commandbutton" />

	ADD OBJECT 'cmdUpdate' AS commandbutton WITH ;
		Caption = "Update", ;
		Height = 27, ;
		Left = 12, ;
		Name = "cmdUpdate", ;
		Top = 408, ;
		Width = 84, ;
		ZOrderSet = 12
		*< END OBJECT: BaseClass="commandbutton" />

	ADD OBJECT 'edtAddr1' AS teditbox WITH ;
		Anchor = 0, ;
		BackStyle = 0, ;
		BorderStyle = 0, ;
		FontBold = .T., ;
		ForeColor = 0,128,0, ;
		Format = "", ;
		Height = 139, ;
		Name = "edtAddr1", ;
		ReadOnly = .T., ;
		ScrollBars = 0, ;
		Top = 17, ;
		Width = 144, ;
		ZOrderSet = 2
		*< END OBJECT: ClassLib="..\common\libs\_lvisual.vcx" BaseClass="editbox" />

	ADD OBJECT 'edtAddr2' AS teditbox WITH ;
		Anchor = 0, ;
		BackStyle = 0, ;
		BorderStyle = 0, ;
		FontBold = .T., ;
		ForeColor = 0,128,0, ;
		Format = "", ;
		Height = 138, ;
		Left = 143, ;
		Name = "edtAddr2", ;
		ReadOnly = .T., ;
		ScrollBars = 0, ;
		Top = 17, ;
		Width = 120, ;
		ZOrderSet = 9
		*< END OBJECT: ClassLib="..\common\libs\_lvisual.vcx" BaseClass="editbox" />

	ADD OBJECT 'edtIns1' AS teditbox WITH ;
		Anchor = 0, ;
		BackStyle = 0, ;
		BorderStyle = 0, ;
		FontBold = .T., ;
		ForeColor = 128,0,0, ;
		Format = "", ;
		Height = 187, ;
		Name = "edtIns1", ;
		ReadOnly = .T., ;
		ScrollBars = 0, ;
		Top = 173, ;
		Width = 144, ;
		ZOrderSet = 4
		*< END OBJECT: ClassLib="..\common\libs\_lvisual.vcx" BaseClass="editbox" />

	ADD OBJECT 'edtIns2' AS teditbox WITH ;
		Anchor = 0, ;
		BackStyle = 0, ;
		BorderStyle = 0, ;
		FontBold = .T., ;
		ForeColor = 128,0,0, ;
		Format = "", ;
		Height = 186, ;
		Left = 143, ;
		Name = "edtIns2", ;
		ReadOnly = .T., ;
		ScrollBars = 0, ;
		Top = 173, ;
		Width = 120, ;
		ZOrderSet = 10
		*< END OBJECT: ClassLib="..\common\libs\_lvisual.vcx" BaseClass="editbox" />

	ADD OBJECT 'edtSum1' AS teditbox WITH ;
		Anchor = 0, ;
		BackStyle = 0, ;
		BorderStyle = 0, ;
		FontBold = .T., ;
		ForeColor = 0,0,128, ;
		Format = "", ;
		Height = 36, ;
		Name = "edtSum1", ;
		ReadOnly = .T., ;
		ScrollBars = 0, ;
		Top = 360, ;
		Width = 144, ;
		ZOrderSet = 5
		*< END OBJECT: ClassLib="..\common\libs\_lvisual.vcx" BaseClass="editbox" />

	ADD OBJECT 'edtSum2' AS teditbox WITH ;
		Anchor = 0, ;
		BackStyle = 0, ;
		BorderStyle = 0, ;
		FontBold = .T., ;
		ForeColor = 0,0,128, ;
		Format = "", ;
		Height = 35, ;
		Left = 143, ;
		Name = "edtSum2", ;
		ReadOnly = .T., ;
		ScrollBars = 0, ;
		Top = 360, ;
		Width = 120, ;
		ZOrderSet = 11
		*< END OBJECT: ClassLib="..\common\libs\_lvisual.vcx" BaseClass="editbox" />

	ADD OBJECT 'lblAddr' AS label WITH ;
		AutoSize = .T., ;
		Caption = "lblAddr", ;
		FontBold = .T., ;
		ForeColor = 0,128,0, ;
		Height = 17, ;
		Left = 7, ;
		Name = "lblAddr", ;
		Top = 3, ;
		Width = 42, ;
		ZOrderSet = 1
		*< END OBJECT: BaseClass="label" />

	ADD OBJECT 'lblIns' AS label WITH ;
		AutoSize = .T., ;
		Caption = "lblIns", ;
		FontBold = .T., ;
		ForeColor = 128,0,0, ;
		Height = 17, ;
		Left = 7, ;
		Name = "lblIns", ;
		Top = 159, ;
		Width = 32, ;
		ZOrderSet = 3
		*< END OBJECT: BaseClass="label" />

	ADD OBJECT 'oHealthCard' AS olehealthcard WITH ;
		Left = 72, ;
		Name = "oHealthCard", ;
		Top = 437, ;
		ZOrderSet = 0
		*< END OBJECT: ClassLib="cit_hicardreader.vcx" BaseClass="olecontrol" OLEObject="d:\code\git\desk\common\dll\cithealthscx.dll" Value="0M8R4KGxGuEAAAAAAAAAAAAAAAAAAAAAPgADAP7/CQAGAAAAAAAAAAAAAAABAAAAAQAAAAAAAAAAEAAAAgAAAAEAAAD+////AAAAAAAAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9/////v////7////+/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////1IAbwBvAHQAIABFAG4AdAByAHkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWAAUA//////////8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAuRuaN2tQBAwAAAAACAAAAAAAAAwBPAGwAZQBPAGIAagBlAGMAdABEAGEAdABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB4AAgEDAAAAAgAAAP////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAfAEAAAAAAAADAEEAYwBjAGUAcwBzAE8AYgBqAFMAaQB0AGUARABhAHQAYQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJgACAP///////////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAA4AAAAAAAAAAMAQwBoAGEAbgBnAGUAZABQAHIAbwBwAHMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAIA////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAQAAAAAAAAAAwAAAP7////+////BAAAAAUAAAAGAAAABwAAAP7///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9Ni6Uy02p7Rrao6S6MJEH0AAEAAAD/////AQAAAAAAAAAEAQAAABxTeXN0ZW0uQ29sbGVjdGlvbnMuSGFzaHRhOAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABibGUHAAAACkxvYWRGYWN0b3IHVmVyc2lvbghDb21wYXJlchBIYXNoQ29kZVByb3ZpZGVyCEhhc2hTaXplBEtleXMGVmFsdWVzAAADAwAFBQsIHFN5c3RlbS5Db2xsZWN0aW9ucy5JQ29tcGFyZXIkU3lzdGVtLkNvbGxlY3Rpb25zLklIYXNoQ29kZVByb3ZpZGVyCOxROD8GAAAACgoHAAAACQIAAAAJAwAAABACAAAABQAAAAYEAAAAB0xvZ0ZpbGUGBQAAAAROYW1lBgYAAAAIVGFiSW5kZXgGBwAAAARTaXplBggAAAAITG9jYXRpb24QAwAAAAUAAAAGCQAAAAAGCgAAABVDb250cm9sQXhTb3VyY2luZ1NpdGUGCwAAAAEwBgwAAAAHMTAwLCAxNwYNAAAABDAsIDALCwAAAA==" />

	ADD OBJECT 'Shape1' AS shape WITH ;
		BackStyle = 0, ;
		Height = 156, ;
		Name = "Shape1", ;
		Width = 264, ;
		ZOrderSet = 6
		*< END OBJECT: BaseClass="shape" />

	ADD OBJECT 'Shape2' AS shape WITH ;
		BackStyle = 0, ;
		Height = 205, ;
		Name = "Shape2", ;
		Top = 155, ;
		Width = 264, ;
		ZOrderSet = 7
		*< END OBJECT: BaseClass="shape" />

	ADD OBJECT 'Shape3' AS shape WITH ;
		BackStyle = 0, ;
		Height = 38, ;
		Name = "Shape3", ;
		Top = 359, ;
		Width = 264, ;
		ZOrderSet = 8
		*< END OBJECT: BaseClass="shape" />
	
	PROCEDURE assigncaption
		this.lblAddr.Caption = GetLangText("HEALTHCARD","TXT_ADDRESSBOOK")
		this.lblIns.Caption = GetLangText("HEALTHCARD","TXT_INSRNAME")
		this.edtAddr1.Value = StrToMsg(GetLangText("HEALTHCARD","TXT_ADDRESS"))
		this.edtIns1.Value = StrToMsg(GetLangText("HEALTHCARD","TXT_INSURANCE")+GetLangText("HEALTHCARD","TXT_ADDRESS"))
		this.edtSum1.Value = StrToMsg(GetLangText("HEALTHCARD","TXT_SUMMARY"))
		this.cmdUpdate.Caption = GetLangText("COMMON","TXT_UPDATE")
		this.cmdOpenInAddress.Caption = GetLangText("HEALTHCARD","TXT_OPENIN_ADDRESSBOOK")
	ENDPROC

	PROCEDURE Destroy
		this.oHealthCard.StopCard()
		this.lPortOpened = .F.
	ENDPROC

	PROCEDURE displaycontent
		LOCAL lcInsuranceFld, llInsuranceIdFound, lcChanged
		
		this.nReserCnt = 0
		lcInsuranceFld = LOWER(_screen.oGlobal.cHiInsuranceNoAdrUserField)
		
		DLocate("address", "UPPER(" + lcInsuranceFld + ") = " + SqlCnv(UPPER(PADR(this.oHealthCard.InsuredNumber,100))))
		this.nAddrId = address.ad_addrid
		lcChanged = EMPTY(this.nAddrId) OR ;
					LOWER(PADR(this.oHealthCard.FirstName,20)) <> LOWER(PADR(address.ad_fname,20)) OR ;
					LOWER(PADR(this.oHealthCard.LastName,30)) <> LOWER(PADR(address.ad_lname,30)) OR ;
					TTOD(this.oHealthCard.Birthday) <> address.ad_birth OR ;
					LOWER(PADR(this.oHealthCard.Street,100)) <> LOWER(PADR(address.ad_street,100)) OR ;
					LOWER(PADR(this.oHealthCard.City,20)) <> LOWER(PADR(address.ad_city,20)) OR ;
					LOWER(PADR(this.oHealthCard.ZipCode,10)) <> LOWER(PADR(address.ad_zip,10)) OR ;
					LOWER(PADR(this.oHealthCard.Country,3)) <> LOWER(PADR(address.ad_country,3))
		
		IF NOT EMPTY(this.nAddrId)
			CALCULATE CNT() FOR rs_addrid = this.nAddrId AND DTOS(rs_depdate)+rs_roomnum > DTOS(Sysdate()) TO this.nReserCnt IN reservat
		ENDIF
		
		STORE IIF(lcChanged, RGB(128,0,0), RGB(0,128,0)) TO this.lblIns.ForeColor, this.edtIns1.ForeColor, this.edtIns2.ForeColor
		this.cmdUpdate.Enabled = lcChanged
		
		this.edtAddr2.Value = StrToMsg("%s1;%s2;%s3;%s4;%s5;%s6;%s7;%s8 %s9;%s10", ALLTRIM(address.&lcInsuranceFld), ALLTRIM(address.ad_fname), ALLTRIM(address.ad_lname), ;
			ALLTRIM(address.ad_title), "", IIF(EMPTY(address.ad_birth), "", TRANSFORM(address.ad_birth)), ;
			ALLTRIM(address.ad_street), ALLTRIM(address.ad_city), ALLTRIM(address.ad_zip), ALLTRIM(address.ad_country))
		
		this.edtIns2.Value = StrToMsg("%s1;%s2;%s3;%s4;%s5;%s6;%s7;%s8;%s9;%s10;%s11 %s12;%s13", ;
			this.oHealthCard.InsuranceName, this.oHealthCard.InsuranceNumber, IIF(this.oHealthCard.InsuranceStartDate < DATE(1900,1,1), "", TRANSFORM(TTOD(this.oHealthCard.InsuranceStartDate))), ;
			this.oHealthCard.InsuredNumber, this.oHealthCard.FirstName, this.oHealthCard.LastName, this.oHealthCard.Title, this.oHealthCard.Sex, ;
			IIF(this.oHealthCard.Birthday < DATE(1900,1,1), "", TRANSFORM(TTOD(this.oHealthCard.Birthday))), ;
			this.oHealthCard.Street, this.oHealthCard.City, this.oHealthCard.ZipCode, this.oHealthCard.Country)
		
		this.edtSum2.Value = StrToMsg("%n1;%n2", this.nAddrId, this.nReserCnt)
	ENDPROC

	PROCEDURE Init
		IF _screen.oGlobal.lHiLog
			this.oHealthCard.LogFile = FULLPATH("healthcard.log")
		ENDIF
		
		this.lPortOpened = this.oHealthCard.StartCard()
		IF NOT this.lPortOpened
			RETURN .F.
		ENDIF
		
		this.SetDebugData()
		
		DODEFAULT()
	ENDPROC

	PROCEDURE KeyPress
		LPARAMETERS nKeyCode, nShiftAltCtrl
		
		* This form doesn't receive any key event
		NODEFAULT
	ENDPROC

	PROCEDURE loaddataenv
		Ini(.T.)
		
		OpenFileDirect(,"address")
		OpenFileDirect(,"reservat")
	ENDPROC

	PROCEDURE moveform
		LOCAL lnTop, lnLeft, lnFormTop, lnFormLeft, lnFormWidth, lnDPHeight, lnDPWidth
		
		IF ISNULL(this.oParent)
			lnFormTop = _screen.Height
			lnFormLeft = _screen.Width
			lnFormWidth = 0
		ELSE
			lnFormTop = this.oParent.Top
			lnFormLeft = this.oParent.Left
			lnFormWidth = this.oParent.Width+2*SYSMETRIC(3)
		ENDIF
		
		lnDPHeight = this.Height+2*SYSMETRIC(13)
		lnDPWidth = this.Width+2*SYSMETRIC(12)
		lnTop = lnFormTop
		lnLeft = lnFormLeft + lnFormWidth
		
		this.Top = MAX(0, MIN(_screen.Height - lnDPHeight, lnTop))
		this.Left = MAX(0, MIN(_screen.Width - lnDPWidth, lnLeft))
	ENDPROC

	PROCEDURE oncardpresent
		LOCAL ARRAY laParams(1)
		LOCAL lcNear, lcLastName, lcFirstName, lcCity
		
		this.DisplayContent()
		
		DO CASE
			CASE this.nReserCnt > 0
				* Filter reservation list.
				DIMENSION laParams(3)
				laParams(1) = 3
				laParams(2) = 0
				laParams(3) = "rs_addrid = " + SqlCnv(this.nAddrId,.T.) + " AND DTOS(rs_depdate)+rs_roomnum > " + SqlCnv(DTOS(Sysdate()),.T.)
				Doform("resbrw","Forms\resbrw",,,@laParams)
		
				this.oParent = _screen.ActiveForm
			CASE this.nAddrId = 0
				lcLastName = this.oHealthCard.LastName
				lcFirstName = this.oHealthCard.FirstName
				lcCity = this.oHealthCard.City
		
				lcNear = SET('near')
				SET NEAR ON
				= SEEK(UPPER(lcLastName),'address','tag2')
				SET NEAR &lcNear
		
				* Select nearest address.
				DIMENSION laParams(7)
				laParams(1) = "BRWL"
				laParams(2) = PROPER(lcLastName)
				laParams(3) = 2		&& Tag2 UPPER(ad_lname)+UPPER(ad_fname)+UPPER(ad_city)
				laParams(4) = 'xx'
				laParams(5) = RECNO("address")
				laParams(6) = 0
				laParams(7) = 3
				doform("addressmask","forms\addressmask",,,@laParams)
		
				this.oParent = _screen.ActiveForm
			OTHERWISE
		ENDCASE
		
		this.Show()
		
		RETURN
	ENDPROC

	PROCEDURE oncardremove
		thisform.Visible = .F.
		this.oParent = .NULL.
	ENDPROC

	PROCEDURE onopeninaddressbook
		LOCAL ARRAY laParams(7)
		LOCAL lcNear, lcLastName, lcFirstName, lcCity
		
		lcLastName = this.oHealthCard.LastName
		lcFirstName = this.oHealthCard.FirstName
		lcCity = this.oHealthCard.City
		
		lcNear = SET('near')
		SET NEAR ON
		IF EMPTY(this.nAddrId)
			= SEEK(UPPER(lcLastName),'address','tag2')
		ELSE
			= SEEK(this.nAddrId,'address','tag1')
		ENDIF
		SET NEAR &lcNear
		
		laParams(1) = IIF(EMPTY(this.nAddrId), "BRWL", "EDIT")
		laParams(2) = PROPER(lcLastName)
		laParams(3) = 2		&& Tag2 UPPER(ad_lname)+UPPER(ad_fname)+UPPER(ad_city)
		laParams(4) = 'xx'
		laParams(5) = RECNO("address")
		laParams(6) = this.nAddrId
		laParams(7) = 3
		doform('addressmask','forms\addressmask',,,@laParams)
		
		IF ISNULL(this.oParent)
			this.oParent = _screen.ActiveForm
		ENDIF
	ENDPROC

	PROCEDURE onupdate
		LOCAL lnAddrId, lcInsuranceFld, loProcAddress AS procaddress OF libs\proc_address.vcx
		
		lnAddrId = this.nAddrId
		IF EMPTY(lnAddrId) AND NOT ISNULL(this.oParent) AND this.oParent.Name == "FAddressMask"
			lnAddrId = this.oParent.Parent.m_getselectedaddress()
		ENDIF
		
		IF NOT EMPTY(lnAddrId) AND YesNo(GetLangText("HEALTHCARD","TXT_WANT_TO_UPDATE_TO_ADDRESSBOOK"))
			lcInsuranceFld = LOWER(_screen.oGlobal.cHiInsuranceNoAdrUserField)
		
			loProcAddress = NEWOBJECT("procaddress","libs\proc_address.vcx")
			loProcAddress.AddressEdit(lnAddrId)
			loProcAddress.oAddress.&lcInsuranceFld = PADR(this.oHealthCard.InsuredNumber,100)
			loProcAddress.oAddress.ad_fname = PADR(this.oHealthCard.FirstName,20)
			loProcAddress.oAddress.ad_lname = PADR(this.oHealthCard.LastName,30)
			loProcAddress.oAddress.ad_title = PADR(this.oHealthCard.Title,20)
			loProcAddress.oAddress.ad_birth = TTOD(this.oHealthCard.Birthday)
			loProcAddress.oAddress.ad_street = PADR(this.oHealthCard.Street,100)
			loProcAddress.oAddress.ad_city = PADR(this.oHealthCard.City,20)
			loProcAddress.oAddress.ad_zip = PADR(this.oHealthCard.ZipCode,10)
			loProcAddress.oAddress.ad_country = PADR(this.oHealthCard.Country,3)
			loProcAddress.oAddress.ad_salute = loProcAddress.AddressMakeSalut(DLookUp("title", "ti_lang = " + ;
				SqlCnv(loProcAddress.oAddress.ad_lang) + " AND ti_titlcod = " + SqlCnv(loProcAddress.oAddress.ad_titlcod), "ti_salute"))
		
			IF 0 = loProcAddress.AddressValid() AND loProcAddress.AddressSave()
				IF EndTransaction()
					this.DisplayContent()
				ELSE
					DoTableRevert(.F.,'address')
				ENDIF
			ENDIF
		ENDIF
		
		RETURN .T.
	ENDPROC

	PROCEDURE oparent_assign
		LPARAMETERS toNewVal
		
		this.oParent = toNewVal
		
		IF ISNULL(this.oParent)
			this.cmdOpenInAddress.Enabled = .T.
		ELSE
			this.cmdOpenInAddress.Enabled = NOT (this.oParent.Name == "FAddressMask")
			this.MoveForm()
		ENDIF
	ENDPROC

	PROCEDURE QueryUnload
		NODEFAULT
	ENDPROC

	PROCEDURE setdebugdata
		*********** Only for debugging. Use Dummy Health card. ***********
		*	debugPD.xml
		*	<?xml version="1.0" encoding="ISO-8859-15" standalone="yes"?>
		*	<vsdp:UC_PersoenlicheVersichertendatenXML CDM_VERSION="5.2.0" xmlns:vsdp="http://ws.gematik.de/fa/vsdm/vsd/v5.2">
		*		<vsdp:Versicherter>
		*			<vsdp:Versicherten_ID>E110510390</vsdp:Versicherten_ID>
		*			<vsdp:Person>
		*				<vsdp:Geburtsdatum>19971228</vsdp:Geburtsdatum>
		*				<vsdp:Vorname>Johny</vsdp:Vorname>
		*				<vsdp:Nachname>Kenedy</vsdp:Nachname>
		*				<vsdp:Geschlecht>M</vsdp:Geschlecht>
		*				<vsdp:StrassenAdresse>
		*					<vsdp:Postleitzahl>12345</vsdp:Postleitzahl>
		*					<vsdp:Ort>Berlin</vsdp:Ort>
		*					<vsdp:Land>
		*						<vsdp:Wohnsitzlaendercode>D</vsdp:Wohnsitzlaendercode>
		*					</vsdp:Land>
		*					<vsdp:Strasse>Duna Ut.</vsdp:Strasse>
		*					<vsdp:Hausnummer>8</vsdp:Hausnummer>
		*				</vsdp:StrassenAdresse>
		*			</vsdp:Person>
		*		</vsdp:Versicherter>
		*	</vsdp:UC_PersoenlicheVersichertendatenXML>
		******************************************************************
		*	debugVD.xml
		*	<?xml version="1.0" encoding="ISO-8859-15" standalone="yes"?>
		*	<vsda:UC_AllgemeineVersicherungsdatenXML CDM_VERSION="5.2.0" xmlns:vsda="http://ws.gematik.de/fa/vsdm/vsd/v5.2">
		*		<vsda:Versicherter>
		*			<vsda:Versicherungsschutz>
		*				<vsda:Beginn>20090101</vsda:Beginn>
		*				<vsda:Kostentraeger>
		*					<vsda:Kostentraegerkennung>103501080</vsda:Kostentraegerkennung>
		*					<vsda:Kostentraegerlaendercode>D</vsda:Kostentraegerlaendercode>
		*					<vsda:Name>BIG direkt gesund</vsda:Name>
		*					<vsda:AbrechnenderKostentraeger>
		*						<vsda:Kostentraegerkennung>103501080</vsda:Kostentraegerkennung>
		*						<vsda:Kostentraegerlaendercode>D</vsda:Kostentraegerlaendercode>
		*						<vsda:Name>BIG direkt gesund</vsda:Name>
		*					</vsda:AbrechnenderKostentraeger>
		*				</vsda:Kostentraeger>
		*			</vsda:Versicherungsschutz>
		*			<vsda:Zusatzinfos>
		*				<vsda:ZusatzinfosGKV>
		*					<vsda:Versichertenart>1</vsda:Versichertenart>
		*					<vsda:Zusatzinfos_Abrechnung_GKV>
		*						<vsda:WOP>20</vsda:WOP>
		*					</vsda:Zusatzinfos_Abrechnung_GKV>
		*				</vsda:ZusatzinfosGKV>
		*			</vsda:Zusatzinfos>
		*		</vsda:Versicherter>
		*	</vsda:UC_AllgemeineVersicherungsdatenXML>
		******************************************************************
		LOCAL lcDebugFile, lcDebugPD, lcDebugVD
		
		STORE "" TO lcDebugFile, lcDebugPD, lcDebugVD
		
		lcDebugFile = "debugPD.xml"
		IF NOT EMPTY(lcDebugFile) AND FILE(lcDebugFile)
			lcDebugPD = CHRTRAN(FILETOSTR(lcDebugFile),CHR(9)+CHR(10)+CHR(13),"")
		ENDIF
		lcDebugFile = "debugVD.xml"
		IF NOT EMPTY(lcDebugFile) AND FILE(lcDebugFile)
			lcDebugVD = CHRTRAN(FILETOSTR(lcDebugFile),CHR(9)+CHR(10)+CHR(13),"")
		ENDIF
		
		this.oHealthCard.SetDebugData(lcDebugPD, lcDebugVD)
		******************************************************************
	ENDPROC

	PROCEDURE Show
		LPARAMETERS nStyle
		
		this.MoveForm()
		
		DODEFAULT(nStyle)
	ENDPROC

	PROCEDURE cmdOpenInAddress.Click
		thisform.OnOpenInAddressBook()
	ENDPROC

	PROCEDURE cmdUpdate.Click
		thisform.OnUpdate()
	ENDPROC

	PROCEDURE oHealthCard.OnCardInsert
		*** ActiveX Control Event ***
		thisform.OnCardPresent()
	ENDPROC

	PROCEDURE oHealthCard.Oncardremove
		*** ActiveX Control Event ***
		thisform.OnCardRemove()
	ENDPROC

ENDDEFINE

DEFINE CLASS crhealthcardtop AS crhealthcard OF "cit_hicardreader.vcx" 
 	*< CLASSDATA: Baseclass="form" Timestamp="" Scale="Pixels" Uniqueid="" />

	DoCreate = .T.
	Name = "crhealthcardtop"
	ShowWindow = 1
	cmdOpenInAddress.Name = "cmdOpenInAddress"
	cmdUpdate.Name = "cmdUpdate"
	edtAddr1.Name = "edtAddr1"
	edtAddr2.Name = "edtAddr2"
	edtIns1.Name = "edtIns1"
	edtIns2.Name = "edtIns2"
	edtSum1.Name = "edtSum1"
	edtSum2.Name = "edtSum2"
	lblAddr.Name = "lblAddr"
	lblIns.Name = "lblIns"
	oHealthCard.Left = 72
	oHealthCard.Name = "oHealthCard"
	oHealthCard.Top = 437
	shape1.Name = "shape1"
	shape2.Name = "shape2"
	Shape3.Name = "Shape3"

ENDDEFINE

DEFINE CLASS crhichandler AS custom 
 	*< CLASSDATA: Baseclass="custom" Timestamp="" Scale="Pixels" Uniqueid="" />

	*<DefinedPropArrayMethod>
		*m: afterlogin
		*m: create
		*m: destroycardreader
		*m: installed
		*m: release		&& Releases a FormSet or Form from memory.
		*m: used
		*p: lavailable
		*p: ocr
	*</DefinedPropArrayMethod>

	Name = "crhichandler"
	ocr = .NULL.
	
	PROCEDURE afterlogin
		this.oCr.LoadDataEnv()
		this.oCr.AssignCaption()
	ENDPROC

	PROCEDURE create
		LPARAMETERS tlTop
		LOCAL lcClass
		
		lcClass = "CrHealthCard"
		
		IF tlTop
			lcClass = lcClass + "Top"
		ENDIF
		
		IF ISNULL(this.oCr) OR LOWER(this.oCr.Class) # LOWER(lcClass)
			this.oCr = .NULL.
			IF EMPTY(_screen.oGlobal.cHiInsuranceNoAdrUserField)
				WAIT GetLangText("HEALTHCARD","TXT_NOTDEFINED_AD_USR") WINDOW TIMEOUT 1
			ELSE
				Sleep(50)
				this.oCr = CREATEOBJECT(lcClass)
			ENDIF
			IF VARTYPE(this.oCr) # "O"
				this.oCr = .NULL.
			ENDIF
			this.lAvailable = NOT ISNULL(this.oCr)
		ENDIF
	ENDPROC

	PROCEDURE Destroy
		this.DestroyCardReader()
	ENDPROC

	PROCEDURE destroycardreader
		this.oCr = .NULL.
		this.lAvailable = NOT ISNULL(this.oCr)
	ENDPROC

	PROCEDURE installed
		LPARAMETERS toDummyForm
		LOCAL loDummyForm, llInstalled
		
		TRY
			toDummyForm.AddObject("HealthCard", "OLEHealthCard")
		CATCH
		ENDTRY
		llInstalled = (VARTYPE(toDummyForm.HealthCard) = "O")
		IF NOT llInstalled
			MESSAGEBOX("CitHealthSCX.dll is not properly installed!")
		ENDIF
		
		RETURN llInstalled
	ENDPROC

	PROCEDURE release		&& Releases a FormSet or Form from memory.
		IF NOT ISNULL(this.oCr)
			this.oCr.Release()
		ENDIF
		RELEASE this
	ENDPROC

	PROCEDURE used
		LOCAL llActive
		
		llActive = terminal.tm_hiactiv
		
		RETURN llActive
	ENDPROC

ENDDEFINE

DEFINE CLASS olehealthcard AS olecontrol 
 	*< CLASSDATA: Baseclass="olecontrol" Timestamp="" Scale="Pixels" Uniqueid="" Nombre="olehealthcard" Parent="" ObjName="olehealthcard" OLEObject="D:\CODE\GIT\DESK\COMMON\DLL\CitHealthSCX.DLL" Value="0M8R4KGxGuEAAAAAAAAAAAAAAAAAAAAAPgADAP7/CQAGAAAAAAAAAAAAAAABAAAAAQAAAAAAAAAAEAAAAgAAAAEAAAD+////AAAAAAAAAAD////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9/////v////7////+/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////1IAbwBvAHQAIABFAG4AdAByAHkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWAAUA//////////8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPDRL8SJ2tQBAwAAAAACAAAAAAAAAwBPAGwAZQBPAGIAagBlAGMAdABEAGEAdABhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB4AAgEDAAAAAgAAAP////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAfAEAAAAAAAADAEEAYwBjAGUAcwBzAE8AYgBqAFMAaQB0AGUARABhAHQAYQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJgACAP///////////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAA4AAAAAAAAAAMAQwBoAGEAbgBnAGUAZABQAHIAbwBwAHMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAIA////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAQAAAAAAAAAAwAAAP7////+////BAAAAAUAAAAGAAAABwAAAP7///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9Ni6Uy02p7Rrao6S6MJEH0AAEAAAD/////AQAAAAAAAAAEAQAAABxTeXN0ZW0uQ29sbGVjdGlvbnMuSGFzaHRhOAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABibGUHAAAACkxvYWRGYWN0b3IHVmVyc2lvbghDb21wYXJlchBIYXNoQ29kZVByb3ZpZGVyCEhhc2hTaXplBEtleXMGVmFsdWVzAAADAwAFBQsIHFN5c3RlbS5Db2xsZWN0aW9ucy5JQ29tcGFyZXIkU3lzdGVtLkNvbGxlY3Rpb25zLklIYXNoQ29kZVByb3ZpZGVyCOxROD8GAAAACgoHAAAACQIAAAAJAwAAABACAAAABQAAAAYEAAAAB0xvZ0ZpbGUGBQAAAAROYW1lBgYAAAAIVGFiSW5kZXgGBwAAAARTaXplBggAAAAITG9jYXRpb24QAwAAAAUAAAAGCQAAAAAGCgAAABVDb250cm9sQXhTb3VyY2luZ1NpdGUGCwAAAAEwBgwAAAAHMTAwLCAxNwYNAAAABDAsIDALCwAAAA==" />

	Name = "olehealthcard"

ENDDEFINE
